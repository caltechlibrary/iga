#!/bin/bash

repodir=$(dirname $(dirname $(dirname $(realpath -- "${BASH_SOURCE[0]}"))))
jsonfile=$repodir/iga/licenses.py
tmpdir=$(mktemp -d)

# Exit if the temp directory wasn't created successfully.
if [ ! -e "$tmpdir" ]; then
    >&2 echo "Failed to create temp directory"
    exit 1
fi

# Make sure the temp directory gets removed on script exit.
trap "exit 1" HUP INT PIPE QUIT TERM
trap 'rm -rf "$tmpdir"' EXIT

cat > $jsonfile <<EOF
'''
licenses.py: license descriptions.

 ╭───────────────────── Notice ── Notice ── Notice ────────────────────╮
 |     THIS FILE IS AUTOMATICALLY GENERATED. DO NOT EDIT THIS FILE.    |
 |  For more info, see the script ../dev/scripts/create-licenses-file  |
 ╰───────────────────── Notice ── Notice ── Notice ────────────────────╯
'''

from collections import namedtuple
from commonpy.data_structures import CaseFoldDict


License = namedtuple('License', 'title description url')


LICENSES = CaseFoldDict({
EOF

cd $tmpdir
git clone git@github.com:github/choosealicense.com.git
for file in choosealicense.com/_licenses/*.txt; do
    key=$(basename $file .txt)
    echo -n '  "'$key'": License(title="' >> $jsonfile
    grep title: $file | awk -F': ' '{print $2}' | tr '"' "'" | tr -d '\r\n' >> $jsonfile
    echo -n '", description="' >> $jsonfile
    grep description: $file | awk -F': ' '{print $2}' | tr '"' "'" | tr -d '\r\n' >> $jsonfile
    echo -n '", url="https://spdx.org/licenses/' >> $jsonfile
    grep spdx-id: $file | awk -F': ' '{print $2}' | tr '"' "'" | tr -d '\r\n' >> $jsonfile
    echo '"),' >> $jsonfile
done

echo '})' >> $jsonfile
